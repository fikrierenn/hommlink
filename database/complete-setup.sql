-- HommLink CRM Complete Database Setup
-- Bu dosyayÄ± Supabase SQL Editor'da tek seferde Ã§alÄ±ÅŸtÄ±rabilirsiniz

-- Enable necessary extensions
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";

-- Users tablosu (basit yapÄ±)
CREATE TABLE public.users (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  auth_uid uuid UNIQUE,
  full_name text,
  role text DEFAULT 'agent',
  created_at timestamptz DEFAULT now()
);

-- Status definitions tablosu (dinamik durum yÃ¶netimi)
CREATE TABLE public.status_definitions (
  id serial PRIMARY KEY,
  code text UNIQUE,
  label text,
  color text,
  order_index int DEFAULT 0,
  is_active boolean DEFAULT true
);

-- Leads tablosu (ana aday yÃ¶netimi)
CREATE TABLE public.leads (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  external_id text,
  source text,
  name text,
  phone text,
  region text,
  city text,
  status_id int REFERENCES public.status_definitions(id),
  notes text,
  next_action text,
  next_action_at timestamptz,
  owner_uid uuid REFERENCES public.users(auth_uid),
  created_at timestamptz DEFAULT now(),
  updated_at timestamptz DEFAULT now()
);

-- Lead events tablosu (tÃ¼m etkileÅŸim geÃ§miÅŸi)
CREATE TABLE public.lead_events (
  id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  lead_id uuid REFERENCES public.leads(id) ON DELETE CASCADE,
  event_type text,
  disposition text,
  note text,
  created_by uuid REFERENCES public.users(auth_uid),
  created_at timestamptz DEFAULT now()
);

-- Updated_at trigger fonksiyonu
CREATE OR REPLACE FUNCTION public.touch_updated_at()
RETURNS trigger AS $$ 
BEGIN 
  NEW.updated_at = now(); 
  RETURN NEW; 
END; 
$$ LANGUAGE plpgsql;

-- Trigger
CREATE TRIGGER trg_leads_touch 
  BEFORE UPDATE ON public.leads
  FOR EACH ROW EXECUTE FUNCTION public.touch_updated_at();

-- Indexes for performance
CREATE INDEX idx_leads_owner_uid ON public.leads(owner_uid);
CREATE INDEX idx_leads_status_id ON public.leads(status_id);
CREATE INDEX idx_leads_phone ON public.leads(phone);
CREATE INDEX idx_lead_events_lead_id ON public.lead_events(lead_id);
CREATE INDEX idx_users_auth_uid ON public.users(auth_uid);

-- Enable RLS on all tables
ALTER TABLE public.users ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.leads ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.lead_events ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.status_definitions ENABLE ROW LEVEL SECURITY;

-- Users table policies
CREATE POLICY "Users can view own profile" ON public.users
  FOR SELECT USING (auth_uid = auth.uid());

CREATE POLICY "Users can update own profile" ON public.users
  FOR UPDATE USING (auth_uid = auth.uid());

CREATE POLICY "Admins can view all users" ON public.users
  FOR SELECT USING (
    EXISTS (
      SELECT 1 FROM public.users 
      WHERE auth_uid = auth.uid() AND role = 'admin'
    )
  );

-- Leads table policies
CREATE POLICY "Agents can view own leads" ON public.leads
  FOR SELECT USING (owner_uid = auth.uid());

CREATE POLICY "Admins can view all leads" ON public.leads
  FOR SELECT USING (
    EXISTS (
      SELECT 1 FROM public.users 
      WHERE auth_uid = auth.uid() AND role = 'admin'
    )
  );

CREATE POLICY "Users can create own leads" ON public.leads
  FOR INSERT WITH CHECK (owner_uid = auth.uid());

CREATE POLICY "Users can update own leads" ON public.leads
  FOR UPDATE USING (owner_uid = auth.uid());

CREATE POLICY "Users can delete own leads" ON public.leads
  FOR DELETE USING (owner_uid = auth.uid());

-- Lead events table policies
CREATE POLICY "Users can view own lead events" ON public.lead_events
  FOR SELECT USING (
    EXISTS (
      SELECT 1 FROM public.leads 
      WHERE id = lead_events.lead_id AND owner_uid = auth.uid()
    )
  );

CREATE POLICY "Admins can view all lead events" ON public.lead_events
  FOR SELECT USING (
    EXISTS (
      SELECT 1 FROM public.users 
      WHERE auth_uid = auth.uid() AND role = 'admin'
    )
  );

CREATE POLICY "Users can create own lead events" ON public.lead_events
  FOR INSERT WITH CHECK (
    created_by = auth.uid() AND
    EXISTS (
      SELECT 1 FROM public.leads 
      WHERE id = lead_events.lead_id AND owner_uid = auth.uid()
    )
  );

-- Status definitions policies
CREATE POLICY "Authenticated users can view status definitions" ON public.status_definitions
  FOR SELECT USING (auth.role() = 'authenticated');

CREATE POLICY "Admins can manage status definitions" ON public.status_definitions
  FOR ALL USING (
    EXISTS (
      SELECT 1 FROM public.users 
      WHERE auth_uid = auth.uid() AND role = 'admin'
    )
  );

-- WhatsApp templates tablosu
CREATE TABLE public.whatsapp_templates (
  id serial PRIMARY KEY,
  code text UNIQUE NOT NULL,
  name text NOT NULL,
  message text NOT NULL,
  variables text[] DEFAULT '{}',
  is_active boolean DEFAULT true,
  created_at timestamptz DEFAULT now()
);

-- Enable RLS on whatsapp_templates
ALTER TABLE public.whatsapp_templates ENABLE ROW LEVEL SECURITY;

-- WhatsApp templates policies (read-only for all authenticated users)
CREATE POLICY "Authenticated users can view templates" ON public.whatsapp_templates
  FOR SELECT USING (auth.role() = 'authenticated');

-- Only admins can modify templates
CREATE POLICY "Admins can manage templates" ON public.whatsapp_templates
  FOR ALL USING (
    EXISTS (
      SELECT 1 FROM public.users 
      WHERE auth_uid = auth.uid() AND role = 'admin'
    )
  );

-- Insert initial status definitions
INSERT INTO public.status_definitions (code, label, color, order_index) VALUES
  ('NEW', 'Yeni', '#D1FAE5', 10),
  ('TO_CALL', 'Aranacak', '#E0E7FF', 20),
  ('WA_SENT', 'Cevap Bekleniyor (WA)', '#FEF3C7', 40),
  ('APPT_SET', 'Randevu Verildi', '#FDE68A', 50),
  ('APPT_CONFIRMED', 'Randevu OnaylandÄ±', '#FCD34D', 55),
  ('FOLLOW_UP', 'Takipte', '#DBEAFE', 60),
  ('QUALIFIED', 'Nitelikli', '#A7F3D0', 70),
  ('CLOSED', 'KapanmÄ±ÅŸ', '#E5E7EB', 90);

-- Insert demo user for testing
INSERT INTO public.users (id, auth_uid, full_name, role) VALUES
  ('00000000-0000-0000-0000-000000000000', '00000000-0000-0000-0000-000000000000', 'Demo User', 'agent')
ON CONFLICT (auth_uid) DO NOTHING;

-- Insert WhatsApp message templates
INSERT INTO public.whatsapp_templates (code, name, message, variables) VALUES
  ('ilkMesaj','Ä°lk TanÄ±ÅŸma ğŸŒ¿','Merhaba {{ad}}! ğŸŒ¿ Ben {{ajan}}, Homm Bitkisel''den yazÄ±yorum. Sizi aramÄ±ÅŸtÄ±m ama ulaÅŸamadÄ±m. DoÄŸal Ã¼rÃ¼nlerle hem saÄŸlÄ±ÄŸÄ±nÄ±za hem de cebinize katkÄ± saÄŸlayacak harika bir fÄ±rsat var! ğŸ’š 2-3 dakika konuÅŸabilir miyiz?',ARRAY['ad', 'ajan']),
  ('cevapsizArama','CevapsÄ±z Arama ğŸ“','{{ad}}, merhaba! ğŸ˜Š Az Ã¶nce sizi aradÄ±m ama meÅŸguldÃ¼nÃ¼z galiba. Homm Bitkisel''le ilgili Ã§ok heyecan verici bir konuyu paylaÅŸmak istiyorum! MÃ¼sait olduÄŸunuzda beni arayabilir misiniz? ğŸŒŸ',ARRAY['ad']),
  ('randevuOner','Randevu Teklifi ğŸ“…','{{ad}}, harika! ğŸ‰ O zaman {{tarih}} gÃ¼nÃ¼ saat {{saat}}''te konuÅŸalÄ±m mÄ±? Size Homm Bitkisel''in sunduÄŸu muhteÅŸem fÄ±rsatlarÄ± anlatacaÄŸÄ±m! Hem doÄŸal yaÅŸam hem de ek gelir... ğŸ’°âœ¨',ARRAY['ad', 'tarih', 'saat']),
  ('randevuOnay','Randevu OnayÄ± âœ…','SÃ¼per {{ad}}! ğŸ™Œ {{tarih}} {{saat}} randevumuz kesin! Sizi arayacaÄŸÄ±m ve hayatÄ±nÄ±zÄ± deÄŸiÅŸtirecek bu fÄ±rsatÄ± detaylÄ±ca anlatacaÄŸÄ±m. HeyecanlÄ±yÄ±m! ğŸš€ğŸ’š',ARRAY['ad', 'tarih', 'saat']),
  ('hatirlatma','Randevu HatÄ±rlatmasÄ± â°','{{ad}}, merhaba! ğŸ˜Š BugÃ¼n saat {{saat}}''te gÃ¶rÃ¼ÅŸeceÄŸimizi hatÄ±rlatmak istedim. Homm Bitkisel''le ilgili size anlatacaklarÄ±m var ki... Ã‡ok heyecanlÄ±yÄ±m! ğŸŒŸ HazÄ±r mÄ±sÄ±nÄ±z?',ARRAY['ad', 'saat']),
  ('takip','Takip MesajÄ± ğŸ”„','Merhaba {{ad}}! ğŸŒ¿ GeÃ§en konuÅŸmamÄ±zÄ± dÃ¼ÅŸÃ¼nÃ¼yordum... Homm Bitkisel ailesine katÄ±lma konusunda ne dÃ¼ÅŸÃ¼nÃ¼yorsunuz? Bu fÄ±rsat Ã§ok deÄŸerli ve sizi kaÃ§Ä±rmak istemiyorum! ğŸ’ KonuÅŸabilir miyiz?',ARRAY['ad']),
  ('motivasyon','Motivasyon MesajÄ± ğŸ’ª','{{ad}}, bugÃ¼n harika bir gÃ¼n! ğŸŒ Homm Bitkisel''le hayallerinizi gerÃ§ekleÅŸtirme zamanÄ± geldi! DoÄŸal Ã¼rÃ¼nlerle hem saÄŸlÄ±k hem de finansal Ã¶zgÃ¼rlÃ¼k... BaÅŸlamaya hazÄ±r mÄ±sÄ±nÄ±z? ğŸš€ğŸ’š',ARRAY['ad']),
  ('basari','BaÅŸarÄ± Hikayesi ğŸ†','{{ad}}, size mÃ¼thiÅŸ bir haber! ğŸ‰ GeÃ§en ay ekibimizden {{isim}} {{miktar}} TL kazandÄ±! Homm Bitkisel''le bu baÅŸarÄ± sizin de olabilir. NasÄ±l mÄ±? Hemen konuÅŸalÄ±m! ğŸ’°âœ¨',ARRAY['ad', 'isim', 'miktar']),
  ('kapanis','KapanÄ±ÅŸ MesajÄ± ğŸ¤','{{ad}}, bilgi verdiÄŸiniz iÃ§in Ã§ok teÅŸekkÃ¼rler! ğŸ™ Åu an uygun deÄŸilseniz anlayÄ±ÅŸla karÅŸÄ±lÄ±yorum. Homm Bitkisel ailesi her zaman burada! Ä°leride fikrini deÄŸiÅŸtirirseniz, kapÄ±mÄ±z aÃ§Ä±k! ğŸ’šğŸŒ¿',ARRAY['ad']);